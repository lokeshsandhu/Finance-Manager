<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Finance Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-light">
  <nav class="navbar navbar-light bg-light mb-3">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">Finance Manager</a>
      <a class="btn btn-outline-primary" href="/setup">Setup</a>
    </div>
  </nav>

  <div class="container mt-3">
    <div class="card p-4 shadow-sm">
      <h4>Add Transaction</h4>
      <form id="transaction-form">
        <div class="row">
          <div class="col-md-4 mb-3">
            <label>Date</label>
            <input type="date" class="form-control" name="date" id="date-field" required>
          </div>
          <div class="col-md-4 mb-3">
            <label>Time</label>
            <input type="time" class="form-control" name="time" required>
          </div>
          <div class="col-md-4 mb-3">
            <label>Type</label>
            <select class="form-control" name="type" id="transaction-type">
              <option value="Online">Online</option>
              <option value="In-Person">In-Person</option>
              <option value="Interac">Interac</option>
              <option value="Cash">Cash</option>
            </select>
          </div>
        </div>

        <div class="row bank-account-section">
          <div class="col-md-6 mb-3">
            <label>Bank</label>
            <select class="form-control" name="bank" id="bank-select">
              <option value="">Select Bank</option>
              {% for bank in banks.keys() %}
                <option value="{{ bank }}">{{ bank }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6 mb-3">
            <label>Account</label>
            <select class="form-control" name="account" id="account-select">
              <option value="">Select Account</option>
            </select>
          </div>
        </div>

        <div class="row interac-options" style="display: none;">
          <div class="col-12 mb-3">
            <label>Interac Type</label>
            <select class="form-control" name="interac_type" id="interac-type">
              <option value="To Someone">To Someone</option>
              <option value="Across Accounts">Across Accounts</option>
            </select>
          </div>
          <div class="col-md-6 mb-3 interac-target-account" style="display: none;">
            <label>Target Bank</label>
            <select class="form-control" name="target_bank" id="target-bank-select">
              <option value="">Select Bank</option>
              {% for bank in banks.keys() %}
                <option value="{{ bank }}">{{ bank }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6 mb-3 interac-target-account" style="display: none;">
            <label>Target Account</label>
            <select class="form-control" name="target_account" id="target-account-select">
              <option value="">Select Account</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="col-md-4 mb-3">
            <label>Transaction Type</label>
            <select class="form-control" name="transaction_direction" id="transaction-direction">
              <option value="Outgoing">Outgoing</option>
              <option value="Incoming">Incoming</option>
            </select>
          </div>
          <div class="col-md-4 mb-3">
            <label>Amount</label>
            <input type="number" class="form-control" name="amount" step="0.01" required>
          </div>
          <div class="col-md-4 mb-3">
            <label>Purpose</label>
            <input type="text" class="form-control" name="purpose" required>
          </div>
        </div>

        <button type="submit" class="btn btn-primary w-100">Add Transaction</button>
      </form>
    </div>

    <div class="card p-4 shadow-sm mt-4">
      <h4>View Transactions</h4>
      <div class="mb-3">
        <div class="row">
          <div class="col-md-3 mb-2">
            <input type="date" class="form-control" id="search-date" value="{{ default_date }}">
          </div>
          <div class="col-md-3 mb-2">
            <input type="text" class="form-control" id="search-keyword" placeholder="Search...">
          </div>
          <div class="col-md-3 mb-2">
            <select class="form-control" id="search-bank">
              <option value="">All Banks</option>
              {% for bank in banks.keys() %}
                <option value="{{ bank }}">{{ bank }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3 mb-2">
            <select class="form-control" id="search-account">
              <option value="">All Accounts</option>
            </select>
          </div>
        </div>
        <button class="btn btn-info w-100" id="search-transactions">Search Transactions</button>
      </div>
      <div class="table-responsive">
        <table class="table table-bordered table-striped">
          <thead>
            <tr>
              <th>Date</th>
              <th>Time</th>
              <th>Type</th>
              <th>Bank</th>
              <th>Account</th>
              <th>Direction</th>
              <th>Amount</th>
              <th>Purpose</th>
            </tr>
          </thead>
          <tbody id="transactions-table"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    $(document).ready(function() {
      // Set default date to today
      $("#date-field").val(new Date().toISOString().slice(0, 10));
      
      // Load today's transactions by default
      fetchTransactionsByDate($("#date-field").val());
      
      // Handle bank change - populate accounts
      $("#bank-select").change(function() {
        const bank = $(this).val();
        populateAccountsForBank(bank, "#account-select");
      });
      
      // Handle search bank change - populate accounts
      $("#search-bank").change(function() {
        const bank = $(this).val();
        populateAccountsForBank(bank, "#search-account");
      });
      
      // Handle target bank change for Interac transfers
      $("#target-bank-select").change(function() {
        const bank = $(this).val();
        populateAccountsForBank(bank, "#target-account-select");
      });
      
      // Handle transaction type to show/hide bank/account fields
      $("#transaction-type").change(function() {
        const type = $(this).val();
        
        if (type === "Cash") {
          $(".bank-account-section").hide();
          $(".interac-options").hide();
        } else if (type === "Interac") {
          $(".bank-account-section").show();
          $(".interac-options").show();
          handleInteracTypeChange();
        } else {
          $(".bank-account-section").show();
          $(".interac-options").hide();
        }
      });
      
      // Handle Interac type changes
      $("#interac-type").change(handleInteracTypeChange);
      
      function handleInteracTypeChange() {
        const interacType = $("#interac-type").val();
        
        if (interacType === "Across Accounts") {
          $(".interac-target-account").show();
        } else {
          $(".interac-target-account").hide();
        }
      }
      
      // Function to populate accounts dropdown for a selected bank
      function populateAccountsForBank(bank, accountSelectSelector) {
        const accountSelect = $(accountSelectSelector);
        accountSelect.empty();
        accountSelect.append('<option value="">Select Account</option>');
        
        if (!bank) return;
        
        // Get account data from the banks object
        {% for bank_name, accounts in banks.items() %}
        if (bank === "{{ bank_name }}") {
          {% for account in accounts %}
          accountSelect.append('<option value="{{ account.name }}">{{ account.name }}</option>');
          {% endfor %}
        }
        {% endfor %}
      }
      
      // Function to fetch and display transactions
      function fetchTransactions(params = {}) {
        const queryString = Object.keys(params)
          .map(key => key + '=' + encodeURIComponent(params[key]))
          .join('&');
          
        $.get("/view_transactions?" + queryString, function(data) {
          let rows = "";
          data.transactions.forEach(function(transaction) {
            const amount = parseFloat(transaction.Amount);
            const amountClass = amount < 0 ? "text-danger" : "text-success";
            
            rows += `<tr>
                      <td>${transaction.Date || ""}</td>
                      <td>${transaction.Time || ""}</td>
                      <td>${transaction.Type || ""}</td>
                      <td>${transaction.Bank || ""}</td>
                      <td>${transaction.Account || ""}</td>
                      <td>${transaction.Direction || ""}</td>
                      <td class="${amountClass}">${amount.toFixed(2)}</td>
                      <td>${transaction.Purpose || ""}</td>
                    </tr>`;
          });
          
          if (rows === "") {
            rows = '<tr><td colspan="8" class="text-center">No transactions found</td></tr>';
          }
          
          $("#transactions-table").html(rows);
        });
      }
      
      // Function to fetch transactions by date
      function fetchTransactionsByDate(date) {
        fetchTransactions({ date: date });
      }
      
      // Search transactions button click
      $("#search-transactions").click(function() {
        const params = {};
        
        const date = $("#search-date").val();
        const keyword = $("#search-keyword").val();
        const bank = $("#search-bank").val();
        const account = $("#search-account").val();
        
        if (date) params.date = date;
        if (keyword) params.keyword = keyword;
        if (bank) params.bank = bank;
        if (account) params.account = account;
        
        fetchTransactions(params);
      });
      
      // Form submission handler
      $("#transaction-form").submit(function(e) {
        e.preventDefault();
        
        // Additional checks for different transaction types
        const transactionType = $("#transaction-type").val();
        
        // For Interac transfers between accounts
        if (transactionType === "Interac" && $("#interac-type").val() === "Across Accounts") {
          // Here you would add logic to handle the transfer between accounts
          // This would typically involve creating two transactions
          // For this version, we'll just add a basic transaction
        }
        
        $.post("/add_transaction", $(this).serialize(), function(response) {
          alert(response.message);
          // Reload transactions for the current date
          fetchTransactionsByDate($("#date-field").val());
          // Reset form
          $("#transaction-form")[0].reset();
          $("#date-field").val(new Date().toISOString().slice(0, 10));
        }).fail(function(error) {
          alert("Error: " + (error.responseJSON?.message || "Could not add transaction"));
        });
      });
    });
  </script>
</body>
</html>
